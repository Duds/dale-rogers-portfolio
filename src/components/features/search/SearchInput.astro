---
import Button from "@/components/ui/Button.astro";
---

<div class="search-bar-container">
  <form
    class="search-form"
    role="search"
    aria-label="Site search"
    autocomplete="off"
    id="search-form"
    action="/search"
    method="get"
  >
    <!-- Main search button with magnifying glass icon -->
    <Button
      type="button"
      id="search-toggle"
      variant="ghost"
      ghostColour="grey"
      aria-label="Toggle search"
      tabindex="0"
      class="search-toggle"
    >
      <svg
        class="search-icon"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </Button>

    <!-- Search input that appears when the button is clicked -->
    <div class="search-input-container">
      <input
        type="text"
        placeholder="Search articles and case studies..."
        class="search-input"
        id="search-input"
        name="q"
        aria-label="Search"
        aria-expanded="false"
        aria-controls="search-results"
        role="combobox"
        autocomplete="off"
      />
    </div>
  </form>
  <div id="search-results" class="search-results hidden" role="listbox">
    <!-- Results will be populated here -->
  </div>
</div>

<script>
  import { useSearch } from "./hooks/useSearch.js";

  let searchInput: HTMLInputElement | null = null;
  let searchResults: HTMLDivElement | null = null;
  let searchToggle: HTMLButtonElement | null = null;
  let searchForm: HTMLFormElement | null = null;
  let searchInputContainer: HTMLDivElement | null = null;
  let expanded = false;

  function expandSearch() {
    console.log("Attempting to expand search", {
      searchForm: !!searchForm,
      searchInput: !!searchInput,
      searchInputContainer: !!searchInputContainer,
    });

    if (!searchForm || !searchInput || !searchInputContainer) {
      console.warn("Cannot expand search - missing elements");
      return;
    }

    expanded = true;
    searchForm.classList.add("expanded");
    searchInputContainer.classList.add("expanded");
    searchInput.focus();

    console.log("Search expanded successfully");
  }

  function collapseSearch() {
    console.log("Attempting to collapse search");

    if (
      !searchForm ||
      !searchInput ||
      !searchResults ||
      !searchInputContainer
    ) {
      console.warn("Cannot collapse search - missing elements");
      return;
    }

    expanded = false;
    searchForm.classList.remove("expanded");
    searchInputContainer.classList.remove("expanded");
    searchInput.value = "";
    searchResults.classList.add("hidden");
    searchInput.setAttribute("aria-expanded", "false");

    console.log("Search collapsed successfully");
  }

  function handleSearchToggle(e: Event) {
    e.preventDefault();

    if (!expanded) {
      expandSearch();
    } else if (searchInput && searchInput.value.trim() !== "") {
      // If expanded and has input, submit the form
      if (searchForm) {
        searchForm.submit();
      }
    } else {
      // If expanded but no input, collapse
      collapseSearch();
    }
  }

  function setupSearch() {
    // Reset search state when setting up
    expanded = false;

    // Get fresh references to DOM elements
    searchInput = document.getElementById(
      "search-input"
    ) as HTMLInputElement | null;
    searchResults = document.getElementById(
      "search-results"
    ) as HTMLDivElement | null;
    searchToggle = document.getElementById(
      "search-toggle"
    ) as HTMLButtonElement | null;
    searchForm = document.getElementById(
      "search-form"
    ) as HTMLFormElement | null;

    // Try multiple ways to find the search input container
    searchInputContainer = document.querySelector(
      ".search-input-container"
    ) as HTMLDivElement | null;
    if (!searchInputContainer && searchForm) {
      // Fallback: look for the container within the form
      searchInputContainer = searchForm.querySelector(
        ".search-input-container"
      ) as HTMLDivElement | null;
    }

    // Debug logging
    console.log("Setting up search with elements:", {
      searchInput: !!searchInput,
      searchResults: !!searchResults,
      searchToggle: !!searchToggle,
      searchForm: !!searchForm,
      searchInputContainer: !!searchInputContainer,
    });

    if (searchToggle && searchInput && searchForm) {
      // Remove existing event listeners to prevent duplicates
      searchToggle.removeEventListener("click", handleSearchToggle);
      searchInput.removeEventListener("focus", expandSearch);

      // Add event listeners
      searchToggle.addEventListener("click", handleSearchToggle);
      searchInput.addEventListener("focus", expandSearch);

      // Handle Enter key in input field
      searchInput.removeEventListener("keydown", handleEnterKey);
      searchInput.addEventListener("keydown", handleEnterKey);

      // Setup search functionality
      if (searchInput && searchResults && searchForm) {
        const { handleSearch, handleKeyDown } = useSearch(
          searchInput,
          searchResults
        );

        // Remove existing listeners to prevent duplicates
        searchInput.removeEventListener("input", handleSearch);
        searchInput.removeEventListener("keydown", handleKeyDown);

        // Add fresh listeners
        searchInput.addEventListener("input", handleSearch);
        searchInput.addEventListener("keydown", handleKeyDown);
      }

      // Ensure search is collapsed initially
      if (searchForm.classList.contains("expanded")) {
        searchForm.classList.remove("expanded");
      }
      if (searchInputContainer?.classList.contains("expanded")) {
        searchInputContainer.classList.remove("expanded");
      }
      if (searchResults?.classList.contains("hidden") === false) {
        searchResults.classList.add("hidden");
      }

      console.log("Search setup complete");
    } else {
      console.warn("Some search elements not found:", {
        searchToggle: !!searchToggle,
        searchInput: !!searchInput,
        searchForm: !!searchForm,
      });
    }

    // Setup global event listeners
    setupGlobalListeners();
  }

  function handleEnterKey(e: KeyboardEvent) {
    if (e.key === "Enter") {
      // Allow normal form submission to the search page
      // We don't need to prevent default here
    }
  }

  function setupGlobalListeners() {
    // Remove existing global listeners to prevent duplicates
    document.removeEventListener("click", handleDocumentClick);
    document.removeEventListener("keydown", handleDocumentKeydown);

    // Add fresh global listeners
    document.addEventListener("click", handleDocumentClick);
    document.addEventListener("keydown", handleDocumentKeydown);
  }

  function handleDocumentClick(event: Event) {
    const target = event.target as Node | null;
    if (
      expanded &&
      target &&
      !searchForm?.contains(target) &&
      !searchResults?.contains(target)
    ) {
      collapseSearch();
    }
  }

  function handleDocumentKeydown(e: KeyboardEvent) {
    if (e.key === "Escape" && expanded) {
      collapseSearch();
    }
  }

  // Initialize on first load
  document.addEventListener("DOMContentLoaded", () => {
    // Small delay to ensure DOM is fully ready
    setTimeout(setupSearch, 10);
  });

  // Re-initialize after Astro page navigation
  document.addEventListener("astro:page-load", () => {
    // Small delay to ensure DOM is fully ready after navigation
    setTimeout(setupSearch, 10);
  });
  document.addEventListener("astro:after-swap", () => {
    // Small delay to ensure DOM is fully ready after swap
    setTimeout(setupSearch, 10);
  });
</script>

<style>
  .search-bar-container {
    position: relative;
    height: 3rem;
    width: 3rem;
    z-index: 50;
  }

  .search-form {
    position: relative;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    transition: all 0.3s ease;
  }

  .search-form.expanded {
    width: auto;
    z-index: 15;
  }

  /* Main search button styling to match navigation buttons */
  .search-toggle {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background-color: transparent;
    border: 2px solid currentColor;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    color: #111827;
    z-index: 20;
    padding: 0;
    position: relative;
  }

  .dark .search-toggle {
    color: #ffffff;
  }

  /* Match hover style of other navigation buttons */
  .search-toggle:hover {
    background-color: #111827;
    color: #ffffff;
  }

  .dark .search-toggle:hover {
    background-color: #ffffff;
    color: #111827;
  }

  /* Direct SVG styling */
  .search-icon {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    stroke-width: 2;
  }

  .search-input-container {
    position: absolute;
    right: calc(100% + 0.75rem);
    top: 0;
    display: flex;
    align-items: center;
    width: 0;
    height: 100%;
    overflow: hidden;
    transition:
      width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.3s ease;
    opacity: 0;
    pointer-events: none;
    z-index: 10;
    background: #ffffff;
    border-radius: 1.5rem;
  }

  .dark .search-input-container {
    background: #111827;
  }

  .search-input-container.expanded {
    width: 16rem;
    opacity: 1;
    pointer-events: all;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .search-input {
    flex: 1;
    height: 3rem;
    border: 2px solid currentColor;
    border-radius: 1.5rem;
    background: #ffffff;
    padding: 0 1rem;
    font-size: 1rem;
    font-weight: 700;
    outline: none;
    color: #111827;
    min-width: 0;
  }

  .dark .search-input {
    background: #111827;
    color: #ffffff;
  }

  .search-results {
    position: absolute;
    top: 3.5rem;
    right: 0;
    width: 20rem;
    z-index: 10;
    background: #ffffff;
    border: 2px solid #111827;
    border-radius: 1rem;
    box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
    max-height: 80vh;
    overflow-y: auto;
  }

  .dark .search-results {
    background: #111827;
    border-color: #ffffff;
  }

  @media (max-width: 768px) {
    .search-input-container.expanded {
      width: 70vw;
      right: 100%;
    }
  }
</style>
