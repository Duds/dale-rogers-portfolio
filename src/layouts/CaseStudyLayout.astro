---
import BaseLayout from "./BaseLayout.astro";
import Container from "@/components/layout/Container.astro";
import { type CollectionEntry } from "astro:content";
import TagList from "@/components/ui/TagList.astro";
import FormattedDate from "@/components/ui/FormattedDate.astro";
import Heading from "@/components/ui/Heading.astro";

interface Props {
  caseStudy: CollectionEntry<"case-studies">;
}

const { caseStudy } = Astro.props;
const {
  title,
  description,
  pubDate,
  tags,
  coverImage,
  client,
  industry,
  duration,
  challenge,
  solution,
  results,
  author,
} = caseStudy.data;
---

<BaseLayout title={title} description={description} image={coverImage}>
  <Container>
    <article class="prose prose-lg dark:prose-invert mx-auto pt-32 md:pt-40">
      <header class="mb-8">
        <Heading level={1} font="fraunces" size="xl" class="mb-4">
          {title}
        </Heading>
        <div class="flex items-center gap-4 text-text-secondary mb-4">
          <FormattedDate date={pubDate} />
          <span>by {author}</span>
        </div>
        {tags && <TagList tags={tags} class="mb-6" />}

        <div
          class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-surface dark:bg-surface-dark p-6 rounded-lg"
        >
          <div>
            <Heading
              level={2}
              font="dm-sans"
              size="4xl"
              class="mb-4 font-normal"
            >
              Project Details
            </Heading>
            <dl class="space-y-2">
              <div>
                <dt class="font-medium">Client</dt>
                <dd>{client}</dd>
              </div>
              <div>
                <dt class="font-medium">Industry</dt>
                <dd>{industry}</dd>
              </div>
              <div>
                <dt class="font-medium">Duration</dt>
                <dd>{duration}</dd>
              </div>
            </dl>
          </div>
          <div>
            <Heading
              level={2}
              font="dm-sans"
              size="4xl"
              class="mb-4 font-normal"
            >
              Overview
            </Heading>
            <dl class="space-y-2">
              <div>
                <dt class="font-medium">Challenge</dt>
                <dd>{challenge}</dd>
              </div>
              <div>
                <dt class="font-medium">Solution</dt>
                <dd>{solution}</dd>
              </div>
              <div>
                <dt class="font-medium">Results</dt>
                <dd>
                  {
                    Array.isArray(results) ? (
                      <ul class="list-disc list-inside">
                        {results.map((result) => (
                          <li>{result}</li>
                        ))}
                      </ul>
                    ) : (
                      results
                    )
                  }
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </header>

      {
        coverImage && (
          <img
            src={coverImage}
            alt={`${client} - ${title}`}
            class="w-full h-[400px] object-cover rounded-lg mb-8"
          />
        )
      }

      <div class="case-study-content">
        <slot />
      </div>
    </article>
  </Container>
</BaseLayout>

<style>
  @reference "tailwindcss";

  .case-study-content :global(img) {
    @apply rounded-lg my-8;
  }

  .case-study-content :global(blockquote) {
    @apply border-l-4 border-purple dark:border-purple-dark pl-4 italic my-8;
  }

  .case-study-content :global(pre) {
    @apply p-4 rounded-lg overflow-x-auto my-8;
  }

  .case-study-content :global(h2) {
    @apply mt-12 mb-6;
  }

  .case-study-content :global(h3) {
    @apply mt-8 mb-4;
  }

  .case-study-content :global(p) {
    @apply mb-6 leading-relaxed;
  }

  .case-study-content :global(ul) {
    @apply list-disc list-inside mb-6;
  }

  .case-study-content :global(ol) {
    @apply list-decimal list-inside mb-6;
  }

  .case-study-content :global(a) {
    @apply text-purple-600 dark:text-purple-400 hover:underline;
  }
</style>

<script>
  // Add Heading components to content headings
  document.addEventListener("DOMContentLoaded", () => {
    const content = document.querySelector(".case-study-content");
    if (!content) return;

    // Replace h2 elements with Heading components
    content.querySelectorAll("h2").forEach((h2) => {
      const heading = document.createElement("astro-heading");
      heading.setAttribute("level", "2");
      heading.setAttribute("font", "dm-sans");
      heading.setAttribute("size", "3xl");
      heading.setAttribute("class", "font-normal");
      heading.innerHTML = h2.innerHTML;
      h2.replaceWith(heading);
    });

    // Replace h3 elements with Heading components
    content.querySelectorAll("h3").forEach((h3) => {
      const heading = document.createElement("astro-heading");
      heading.setAttribute("level", "3");
      heading.setAttribute("font", "dm-sans");
      heading.setAttribute("size", "4xl");
      heading.setAttribute("class", "font-normal");
      heading.innerHTML = h3.innerHTML;
      h3.replaceWith(heading);
    });
  });
</script>
